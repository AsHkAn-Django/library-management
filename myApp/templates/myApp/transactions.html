{% extends 'base.html' %}
{% load django_bootstrap5 %}

{% block content %}

<div class="container my-5">

  <h2>Enter the book code and choose the action:</h2>
  <button id="start-scan-btn" class="btn btn-success mb-3">ðŸ“· Start Camera</button>
  <form id="transaction-form" action="" method="post">
    {% csrf_token %}
    {% bootstrap_form form %}
    <button type="submit" class="btn btn-outline-primary">Go</button>
  </form>

  <hr class="my-4">

  <div class="container my-5">
    <div id="scanner-container" style="display: none; width:100%; max-width:500px; height:300px; border:1px solid #ccc;">
      <div id="scanner" style="width:100%; height:100%;"></div>
    </div>
  </div>

</div>

<script src="https://unpkg.com/@ericblade/quagga2@v0.0.10/dist/quagga.min.js"></script>
<script>
  let quaggaStarted = false;

  document.getElementById('start-scan-btn').addEventListener('click', function() {
    const container = document.getElementById('scanner-container');
    container.style.display = 'block';
    if (!quaggaStarted) {
      quaggaStarted = true;
      Quagga.init({
        inputStream: {
          type: "LiveStream",
          target: document.getElementById('scanner'),
          constraints: { facingMode: "environment" }
        },
        decoder: { readers: ["code_128_reader"] }
      }, function(err) {
        if (err) { console.error(err); return; }
        Quagga.start();
      });

      Quagga.onDetected(function(result) {
        const code = result.codeResult.code;
        document.getElementById("barcode-result").textContent = code;
        // paste into the 'code' input of the form
        const codeInput = document.querySelector('input[name="code"]');
        if (codeInput) { codeInput.value = code; }
        Quagga.stop();
        container.style.display = 'none';
      });
    }
  });
</script>

{% endblock content %}
